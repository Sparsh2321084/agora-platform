"use strict";(self.webpackChunkagora_platform=self.webpackChunkagora_platform||[]).push([[487],{2406:(e,s,t)=>{t.d(s,{A:()=>c});var n=t(5043),o=t(5396),i=t(579);const c=e=>{let{end:s,duration:t=2e3,prefix:c="",suffix:r="",className:a=""}=e;const[l,d]=(0,n.useState)(0),[u,h]=(0,o.wd)({once:!0,threshold:.3}),m=(0,n.useRef)(!1);return(0,n.useEffect)(()=>{if(h&&!m.current){let e,n;m.current=!0;const o=i=>{e||(e=i);const c=Math.min((i-e)/t,1),r=1-Math.pow(1-c,4);d(Math.floor(r*s)),c<1&&(n=requestAnimationFrame(o))};return n=requestAnimationFrame(o),()=>{n&&cancelAnimationFrame(n)}}},[h,s,t]),(0,i.jsxs)("span",{ref:u,className:a,children:[c,l.toLocaleString(),r]})}},6995:(e,s,t)=>{t.d(s,{A:()=>c});var n=t(5043),o=t(3488),i=t(579);const c=function(e){let{itemId:s,itemType:t,initialScore:c=0,initialUpvotes:r=0,initialDownvotes:a=0,initialUserVote:l=null,userId:d,discussionId:u=null,onVoteChange:h=null,disabled:m=!1}=e;const[p,v]=(0,n.useState)(c),[y,g]=(0,n.useState)(r),[f,x]=(0,n.useState)(a),[j,N]=(0,n.useState)(l),[k,S]=(0,n.useState)(!1),[w,I]=(0,n.useState)(!1);(0,n.useEffect)(()=>{v(c),g(r),x(a),N(l)},[c,r,a,l]);const b=async e=>{if(d){if(!k&&!m){S(!0),I(!0);try{const n="discussion"===t?"".concat(o.A.API_URL,"/discussions/").concat(s,"/vote"):"".concat(o.A.API_URL,"/replies/").concat(s,"/vote"),i="discussion"===t?{userId:d,voteType:e}:{userId:d,voteType:e,discussionId:u},c=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),r=await c.json();c.ok?(v(r.score),g(r.upvotes),x(r.downvotes),N(r.vote),h&&h({score:r.score,upvotes:r.upvotes,downvotes:r.downvotes,userVote:r.vote})):console.error("Vote error:",r.message)}catch(n){console.error("Error voting:",n)}finally{S(!1),setTimeout(()=>I(!1),300)}}}else alert("Please login to vote")};return(0,i.jsxs)("div",{className:"vote-container ".concat(w?"animating":""),children:[(0,i.jsx)("button",{className:"vote-btn upvote-btn ".concat("upvote"===j?"active":""," ").concat(k?"voting":""),onClick:()=>b("upvote"),disabled:k||m,title:"Upvote (".concat(y,")"),"aria-label":"Upvote",children:(0,i.jsx)("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",className:"vote-icon",children:(0,i.jsx)("path",{d:"M12 4L4 12h5v8h6v-8h5z",fill:"currentColor"})})}),(0,i.jsxs)("div",{className:"vote-score ".concat(p>0?"positive":p<0?"negative":"neutral"),children:[(0,i.jsx)("span",{className:"score-number",children:(_=p,_>=1e6?(_/1e6).toFixed(1)+"M":_>=1e3?(_/1e3).toFixed(1)+"k":_.toString())}),Math.abs(p)>0&&(0,i.jsx)("div",{className:"score-breakdown",title:"".concat(y," upvotes, ").concat(f," downvotes"),children:(0,i.jsxs)("span",{className:"breakdown-text",children:[(y/(y+f||1)*100).toFixed(0),"% upvoted"]})})]}),(0,i.jsx)("button",{className:"vote-btn downvote-btn ".concat("downvote"===j?"active":""," ").concat(k?"voting":""),onClick:()=>b("downvote"),disabled:k||m,title:"Downvote (".concat(f,")"),"aria-label":"Downvote",children:(0,i.jsx)("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",className:"vote-icon",children:(0,i.jsx)("path",{d:"M12 20L4 12h5V4h6v8h5z",fill:"currentColor"})})})]});var _}},7487:(e,s,t)=>{t.r(s),t.d(s,{default:()=>v});var n=t(2555),o=t(5043),i=t(9001),c=t(6042),r=t(8660),a=t(2406),l=t(6995),d=t(3488),u=t(2104);const h=new class{constructor(){this.socket=null,this.isConnected=!1,this.eventListeners=new Map,this.reconnectAttempts=0,this.maxReconnectAttempts=5}connect(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(this.socket&&this.isConnected)return console.log("Socket already connected"),this.socket;try{return this.socket=(0,u.io)(d.A.API_URL,{transports:["websocket","polling"],reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:5e3,reconnectionAttempts:this.maxReconnectAttempts,timeout:1e4}),this.setupEventHandlers(e),this.socket}catch(s){return console.error("Socket connection error:",s),null}}setupEventHandlers(e){this.socket.on("connect",()=>{console.log("\u2705 Socket connected:",this.socket.id),this.isConnected=!0,this.reconnectAttempts=0,e&&this.emit("user_online",{userId:e.userId,username:e.username})}),this.socket.on("disconnect",e=>{console.log("\u274c Socket disconnected:",e),this.isConnected=!1,"io server disconnect"===e&&this.socket.connect()}),this.socket.on("connect_error",e=>{console.error("Connection error:",e),this.reconnectAttempts++,this.reconnectAttempts>=this.maxReconnectAttempts&&(console.error("Max reconnection attempts reached"),this.disconnect())}),this.socket.on("reconnect",s=>{console.log("\ud83d\udd04 Reconnected after ".concat(s," attempts")),this.isConnected=!0,this.reconnectAttempts=0,e&&this.emit("user_online",{userId:e.userId,username:e.username})})}emit(e,s){return this.socket&&this.isConnected?(this.socket.emit(e,s),!0):(console.warn("Cannot emit ".concat(e,": Socket not connected")),!1)}on(e,s){this.socket?(this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(s),this.socket.on(e,s)):console.warn("Cannot listen to ".concat(e,": Socket not initialized"))}off(e,s){if(this.socket&&(this.socket.off(e,s),this.eventListeners.has(e))){const t=this.eventListeners.get(e),n=t.indexOf(s);n>-1&&t.splice(n,1)}}joinDiscussion(e,s,t){return this.emit("join_discussion",{discussionId:e,userId:s,username:t})}leaveDiscussion(e,s){return this.emit("leave_discussion",{discussionId:e,username:s})}typingStart(e,s){return this.emit("typing_start",{discussionId:e,username:s})}typingStop(e,s){return this.emit("typing_stop",{discussionId:e,username:s})}disconnect(){if(this.socket){for(const[e,s]of this.eventListeners.entries())s.forEach(s=>{this.socket.off(e,s)});this.eventListeners.clear(),this.socket.disconnect(),this.socket=null,this.isConnected=!1,console.log("Socket disconnected and cleaned up")}}isSocketConnected(){return this.socket&&this.isConnected}getSocket(){return this.socket}};var m=t(579);const p=(0,o.memo)(e=>{let{reply:s,index:t,userId:n,discussionId:o}=e;return(0,m.jsxs)("div",{className:"reply-card scroll-reveal",style:{animationDelay:"".concat(.1*t,"s")},children:[(0,m.jsx)("div",{className:"reply-vote-section",children:(0,m.jsx)(l.A,{itemId:s.id,itemType:"reply",initialScore:s.score||0,initialUpvotes:s.upvotes||0,initialDownvotes:s.downvotes||0,initialUserVote:s.userVote||null,userId:n,discussionId:o})}),(0,m.jsxs)("div",{className:"reply-main-content",children:[(0,m.jsxs)("div",{className:"reply-header",children:[(0,m.jsxs)("span",{className:"reply-author",children:["\ud83d\udc64 ",s.username]}),(0,m.jsx)("span",{className:"reply-date",children:new Date(s.created_at).toLocaleDateString()})]}),(0,m.jsx)("p",{className:"reply-content",children:s.content})]})]})});p.displayName="ReplyCard";const v=function(){const{id:e}=(0,i.g)(),s=(0,i.Zp)(),[t,l]=(0,o.useState)(null),[u,v]=(0,o.useState)([]),[y,g]=(0,o.useState)(!0),[f,x]=(0,o.useState)(null),[j,N]=(0,o.useState)(""),[k,S]=(0,o.useState)(!1),[w,I]=(0,o.useState)([]),[b,_]=(0,o.useState)(0),A=(0,o.useRef)(null),C=(0,o.useRef)(!1),L=JSON.parse(localStorage.getItem("agoraUser")||"{}"),R=(0,o.useCallback)(async()=>{g(!0);try{const t=await fetch("".concat(d.A.API_URL,"/discussions/").concat(e)),n=await t.json();t.ok?(l(n.discussion),v(n.replies||[])):(x({message:"Discussion not found",type:"error"}),setTimeout(()=>s("/dashboard"),2e3))}catch(t){console.error("Error fetching discussion:",t),x({message:"Network error",type:"error"})}finally{g(!1)}},[e,s]);(0,o.useEffect)(()=>{h.isSocketConnected()||h.connect(L),e&&L.userId&&h.joinDiscussion(e,L.userId,L.username);const s=s=>{s.discussionId===parseInt(e)&&(v(e=>[...e,s.reply]),x({message:"New reply from ".concat(s.reply.username),type:"success"}),l(e=>e?(0,n.A)((0,n.A)({},e),{},{replies:(e.replies||0)+1}):e))},t=e=>{I(e.typingUsers.filter(e=>e!==L.username))},o=e=>{I(e.typingUsers.filter(e=>e!==L.username))},i=e=>{_(e.usersPresent)},c=e=>{_(e.usersPresent),x({message:"".concat(e.username," joined the discussion"),type:"info"})},r=e=>{x({message:"".concat(e.username," left the discussion"),type:"info"})};return h.on("new_reply",s),h.on("user_typing",t),h.on("user_stopped_typing",o),h.on("discussion_joined",i),h.on("user_joined_discussion",c),h.on("user_left_discussion",r),()=>{e&&L.username&&h.leaveDiscussion(e,L.username),h.off("new_reply",s),h.off("user_typing",t),h.off("user_stopped_typing",o),h.off("discussion_joined",i),h.off("user_joined_discussion",c),h.off("user_left_discussion",r)}},[e,L.userId,L.username]),(0,o.useEffect)(()=>{R()},[R]);const D=(0,o.useCallback)(async s=>{if(s.preventDefault(),j.trim())if(L.userId){C.current&&(h.typingStop(e,L.username),C.current=!1),S(!0);try{const s=await fetch("".concat(d.A.API_URL,"/replies"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({discussionId:e,userId:L.userId,username:L.username,content:j})}),t=await s.json();s.ok?(x({message:"Reply added successfully!",type:"success"}),N("")):x({message:t.message||"Failed to add reply",type:"error"})}catch(t){console.error("Error submitting reply:",t),x({message:"Network error",type:"error"})}finally{S(!1)}}else x({message:"Please login to reply",type:"error"});else x({message:"Reply cannot be empty",type:"error"})},[e,L.userId,L.username,j]),U=(0,o.useCallback)(s=>{const t=s.target.value;N(t),t&&!C.current&&(h.typingStart(e,L.username),C.current=!0),A.current&&clearTimeout(A.current),A.current=setTimeout(()=>{C.current&&(h.typingStop(e,L.username),C.current=!1)},2e3),!t&&C.current&&(h.typingStop(e,L.username),C.current=!1,A.current&&clearTimeout(A.current))},[e,L.username]),P=e=>new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"});return(0,m.jsxs)(m.Fragment,{children:[f&&(0,m.jsx)(c.A,{message:f.message,type:f.type,onClose:()=>x(null)}),(0,m.jsx)(r.A,{}),(0,m.jsx)("div",{className:"discussion-page",children:(0,m.jsxs)("div",{className:"discussion-container",children:[(0,m.jsxs)("div",{className:"discussion-header-section",children:[(0,m.jsx)("div",{className:"discussion-category-tag",children:t.category||"General"}),(0,m.jsx)("h1",{className:"discussion-title",children:t.title}),(0,m.jsxs)("div",{className:"discussion-meta-info",children:[(0,m.jsxs)("span",{className:"meta-item",children:["\ud83d\udc64 ",t.username]}),(0,m.jsxs)("span",{className:"meta-item",children:["\ud83d\udcc5 ",P(t.created_at)]}),(0,m.jsxs)("span",{className:"meta-item",children:["\ud83d\udc41\ufe0f ",t.views," views"]}),(0,m.jsxs)("span",{className:"meta-item",children:["\ud83d\udcac ",u.length," replies"]}),b>0&&(0,m.jsxs)("span",{className:"meta-item live-indicator",title:"".concat(b," ").concat(1===b?"person":"people"," viewing this discussion"),children:["\ud83d\udfe2 ",b," online"]})]})]}),(0,m.jsxs)("div",{className:"discussion-content-section",children:[(0,m.jsxs)("div",{className:"original-post",children:[(0,m.jsxs)("div",{className:"post-author",children:[(0,m.jsx)("div",{className:"author-avatar",children:"\ud83d\udc64"}),(0,m.jsxs)("div",{className:"author-info",children:[(0,m.jsx)("div",{className:"author-name",children:t.username}),(0,m.jsx)("div",{className:"author-date",children:P(t.created_at)})]})]}),(0,m.jsx)("div",{className:"post-content",children:t.content})]}),(0,m.jsxs)("div",{className:"replies-section scroll-reveal",children:[(0,m.jsxs)("h2",{className:"replies-heading",children:["\ud83d\udcac ",(0,m.jsx)(a.A,{end:u.length})," ",1===u.length?"Reply":"Replies"]}),0===u.length?(0,m.jsx)("div",{className:"no-replies",children:(0,m.jsx)("p",{children:"No replies yet. Be the first to share your thoughts!"})}):(0,m.jsx)("div",{className:"replies-list",children:u.map((s,t)=>(0,m.jsx)(p,{reply:s,index:t,userId:L.userId,discussionId:e},t))})]}),(0,m.jsxs)("div",{className:"reply-form-section scroll-reveal",children:[(0,m.jsx)("h3",{children:"Add Your Reply"}),w.length>0&&(0,m.jsxs)("div",{className:"typing-indicator",children:[(0,m.jsxs)("span",{className:"typing-dots",children:[(0,m.jsx)("span",{}),(0,m.jsx)("span",{}),(0,m.jsx)("span",{})]}),(0,m.jsx)("span",{className:"typing-text",children:1===w.length?"".concat(w[0]," is typing..."):2===w.length?"".concat(w[0]," and ").concat(w[1]," are typing..."):"".concat(w[0]," and ").concat(w.length-1," others are typing...")})]}),(0,m.jsxs)("form",{onSubmit:D,children:[(0,m.jsx)("textarea",{placeholder:"Share your thoughts on this discussion...",value:j,onChange:U,rows:5,disabled:k||y,minLength:1,maxLength:2e3,"aria-label":"Reply content","aria-required":"true"}),(0,m.jsxs)("small",{className:"char-count","aria-live":"polite",children:[j.length,"/2000 characters"]}),(0,m.jsx)("button",{type:"submit",className:"reply-submit-btn ripple-button",disabled:k||y,"aria-label":"Post your reply",children:k?"Posting...":"\ud83d\udce4 Post Reply"})]})]})]})]})})]})}}}]);
//# sourceMappingURL=487.8d6691da.chunk.js.map